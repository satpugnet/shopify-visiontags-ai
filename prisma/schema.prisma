generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?

  @@index([shop])
}

model Job {
  id           String    @id @default(uuid())
  shop         String
  collectionId String?
  status       String    @default("QUEUED")
  totalItems   Int       @default(0)
  processed    Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  products     Product[]

  @@index([shop])
  @@index([status])
}

model Product {
  id                  String    @id
  jobId               String
  title               String
  imageUrl            String
  currentCategory     String?
  currentMetafields   Json?
  currentTags         String?
  suggestedMetafields Json?
  suggestedTags       Json?
  syncedAt            DateTime?
  status              String    @default("PENDING")
  error               String?
  createdAt           DateTime  @default(now())
  job                 Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([status])
}

model ShopSettings {
  id                  String   @id @default(uuid())
  shop                String   @unique
  plan                String   @default("FREE")
  creditsUsed         Int      @default(0)
  creditLimit         Int      @default(50)
  billingPeriodStart  DateTime @default(now())
  autoSyncNewProducts Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model UsageRecord {
  id        String   @id @default(uuid())
  shop      String
  month     String
  count     Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([shop, month])
}
